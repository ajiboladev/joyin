<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Photo | JOYIN</title>
    <!-- Add your CSS link -->
    <link rel="stylesheet" href="./profile-image.css">
    <link rel="icon" type="image/x-icon" href="../../joyin-favicon.ico">

    <link rel="manifest" href="../../manifest.json">
<meta name="theme-color" content="#5b53f2">
<script src="../../pwa-install.js"></script>
    
    <!-- ‚úÖ ADD FIREBASE IMPORTS IN THE HEAD -->
    <script type="module">
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { auth, db } from "../../firebase.js";

    document.addEventListener('DOMContentLoaded', async () => {
        console.log("‚úÖ Photo viewer page loaded");
        
        // Get the image element and make it globally accessible
        const mainImage = window.mainImage = document.getElementById('main-image');
        const imageInfo = window.imageInfo = document.getElementById('image-info');
        
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');
        
        if (!userId) {
            console.error("‚ùå No user ID provided in URL");
            mainImage.src = "https://tse1.mm.bing.net/th/id/OIP.cEvbluCvNFD_k4wC3k-_UwHaHa?rs=1&pid=ImgDetMain&o=7&rm=3";
            imageInfo.textContent = "No user specified";
            return;
        }
        
        console.log("üë§ Loading photo for user:", userId);
        
        try {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const data = userSnap.data();
                // console.log("üì∏ User data found:", data);
                
                if (data.profilePic && data.profilePic.startsWith('https://')) {
                    mainImage.src = data.profilePic || "https://tse1.mm.bing.net/th/id/OIP.cEvbluCvNFD_k4wC3k-_UwHaHa?rs=1&pid=ImgDetMain&o=7&rm=3";;
                    console.log("‚úÖ Image src set to:", data.profilePic);
                } else {
                    mainImage.src = data.profilePic || "https://tse1.mm.bing.net/th/id/OIP.cEvbluCvNFD_k4wC3k-_UwHaHa?rs=1&pid=ImgDetMain&o=7&rm=3";
                    console.log("‚ö†Ô∏è No valid profilePic, using default");
                }
                
                // Update info with username if available
                if (data.username) {
                    imageInfo.innerHTML = `@${data.username}'s profile photo ‚Ä¢ Click to zoom`;
                }
            } else {
                console.log("‚ùå User document not found");
                mainImage.src = "https://tse1.mm.bing.net/th/id/OIP.cEvbluCvNFD_k4wC3k-_UwHaHa?rs=1&pid=ImgDetMain&o=7&rm=3";
                imageInfo.textContent = "User not found";
            }
        } catch (error) {
            console.error("‚ùå Error loading user data:", error);
            mainImage.src = "https://tse1.mm.bing.net/th/id/OIP.cEvbluCvNFD_k4wC3k-_UwHaHa?rs=1&pid=ImgDetMain&o=7&rm=3";
            imageInfo.textContent = "Error loading photo";
        }
    });
</script>
</head>
<body>
    <!-- Close Button -->
    <button class="close-btn" onclick="closeViewer()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    
    <div class="container">
        <!-- ‚úÖ IMAGE TAG IS HERE IN THE HTML -->
        <!-- Note: src starts empty, will be filled by JavaScript above -->
        <div class="image-box">
            <img src="" alt="User's Profile Photo" class="main-image" id="main-image" onclick="toggleZoom()">
        </div>
        
        <!-- Controls (same as before) -->
        <div class="controls">
            <button class="btn zoom-btn" onclick="toggleZoom()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    <line x1="11" y1="8" x2="11" y2="14"></line>
                    <line x1="8" y1="11" x2="14" y2="11"></line>
                </svg>
                Zoom
            </button>
            
            <button class="btn download-btn" onclick="downloadImage()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download
            </button>
            
            <button class="btn share-btn" onclick="shareImage()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
                Share
            </button>
        </div>
        
        <!-- Image Info -->
        <div class="image-info" id="image-info">
            Loading photo...
        </div>
    </div>

    <!-- ‚úÖ YOUR ORIGINAL VIEWER FUNCTIONS -->
    <script>
    // Variables - these will be set by the module
    let isZoomed = false;
    
    // Image load handler
    if (window.mainImage) {
        window.mainImage.onload = function() {
            if (window.imageInfo && this.naturalWidth) {
                const sizeText = this.naturalWidth + '√ó' + this.naturalHeight;
                const currentText = window.imageInfo.textContent;
                window.imageInfo.innerHTML = `${currentText} ‚Ä¢ ${sizeText} ‚Ä¢ Press ESC to close`;
            }
        };
    }
    
    function toggleZoom() {
        if (!window.mainImage) return;
        
        if (isZoomed) {
            window.mainImage.classList.remove('zoomed');
        } else {
            window.mainImage.classList.add('zoomed');
        }
        isZoomed = !isZoomed;
    }
    
    function downloadImage() {
        if (!window.mainImage || !window.mainImage.src) {
            showNotification('No image to download');
            return;
        }
        
        const link = document.createElement('a');
        link.href = window.mainImage.src;
        link.download = 'joyin-profile-' + Date.now() + '.jpg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Download started!');
    }
    
    // Share function remains the same (uses window.location.origin)
    async function shareImage() {
        if (!window.mainImage || !window.mainImage.src) {
            showNotification('No image to share');
            return;
        }
        
        try {
            if (navigator.share && window.isSecureContext) {
                const currentUid = new URLSearchParams(window.location.search).get('uid');
                const shareUrl = `${window.location.origin}/profile/profile-image/?uid=${currentUid}`;
                
                await navigator.share({
                    title: 'Profile Photo',
                    text: 'Check out this profile photo from JOYIN',
                    url: shareUrl
                });
                
                console.log('Share successful');
            } else {
                fallbackShare();
            }
        } catch (error) {
            console.error('Share failed:', error);
            if (error.name !== 'AbortError') {
                fallbackShare();
            }
        }
    }
    
    function fallbackShare() {
        const currentUid = new URLSearchParams(window.location.search).get('uid');
        const shareUrl = `${window.location.origin}/profile/profile-image/?uid=${currentUid}`;
        
        navigator.clipboard.writeText(shareUrl)
            .then(() => showNotification('Profile link copied!'))
            .catch(() => prompt('Copy this link:', shareUrl));
    }
    
    function showNotification(message) {
        // Your existing notification code...
    }
    
    function closeViewer() {
        window.history.back();
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') closeViewer();
        if (event.key === 'z' || event.key === 'Z') toggleZoom();
        if (event.key === 'd' || event.key === 'D') downloadImage();
    });
</script>
</body>
</html>